{"version":3,"sources":["../src/Timeline.js"],"names":["defaultClock","DefaultClock","repeatDirections","DEFAULT","ALTERNATE","states","FORWARD","REVERSE","STOPPED","Scrubber","animations","clock","duration","timeScale","repeatDirection","_timeScale","_progress","_duration","_lastTimestamp","_animationFrame","_iterations","_repeat","_repeatDirection","tick","bind","currentValues","state","animators","map","animation","Animator","Animation","createCurrentValues","reduce","results","animator","name","property","from","now","register","notify","type","timestamp","deltaTime","step","progress","seek","stop","unregister","lastProgress","getValuesAt","time","filter","startAt","forEach","render","min","Math","max","endAt","value","Observable"],"mappings":"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","sourcesContent":["import Observable from \"./Observable.js\";\nimport DefaultClock from \"./DefaultClock.js\";\nimport Animator from \"./Animator.js\";\nimport Animation from \"./Animation.js\";\n\nconst defaultClock = new DefaultClock();\n\nconst repeatDirections = {\n  DEFAULT: 0,\n  ALTERNATE: 1,\n};\n\nconst states = {\n  FORWARD: 1,\n  REVERSE: -1,\n  STOPPED: 0,\n};\n\nexport default class Scrubber extends Observable {\n  static get repeatDirections() {\n    return repeatDirections;\n  }\n\n  static get states() {\n    return states;\n  }\n\n  constructor({\n    animations,\n    clock,\n    duration,\n    timeScale,\n    repeatDirection = Scrubber.repeatDirections.DEFAULT,\n  }) {\n    super();\n    this._timeScale = 1;\n    this._progress = 0;\n    this._duration = 0;\n    this._lastTimestamp = 0;\n    this._animationFrame = null;\n    this._iterations = 0;\n    this._repeat = 1;\n    this._repeatDirection = repeatDirection;\n    this.tick = this.tick.bind(this);\n    this.currentValues = {};\n\n    this.clock = clock || defaultClock;\n    this.state = Scrubber.states.STOPPED;\n    this.timeScale = timeScale;\n    this.duration = duration;\n\n    this.animators = animations.map(\n      (animation) => new Animator(new Animation(animation))\n    );\n\n    this.createCurrentValues();\n  }\n\n  get progress() {\n    return this._progress;\n  }\n\n  get timeScale() {\n    return this._timeScale;\n  }\n\n  set timeScale(value) {\n    if (value > 0) {\n      this._timeScale = value;\n    }\n  }\n\n  get duration() {\n    return this._duration;\n  }\n\n  set duration(value) {\n    if (typeof value !== \"number\") {\n      value = 0;\n    }\n\n    // Virtually Nothing. All Math blows up if the duration is \"0\".\n    if (value <= 0) {\n      value = 0.00001;\n    }\n\n    this._duration = value;\n  }\n\n  get repeat() {\n    return this._repeat;\n  }\n\n  set repeat(value) {\n    if (typeof value !== \"number\" && value > 0) {\n      return;\n    }\n\n    this._repeat = value;\n  }\n\n  get repeatDirection() {\n    return this._repeatDirection;\n  }\n\n  set repeatDirection(value) {\n    if ((value !== 0) & (value !== 1)) {\n      return;\n    }\n\n    this._repeatDirection = value;\n  }\n\n  createCurrentValues() {\n    this.currentValues = this.animators.reduce((results, animator) => {\n      let animation = results[animator.animation.name];\n\n      if (animation == null) {\n        animation = results[animator.animation.name] = {};\n      }\n\n      if (animation[animator.animation.property] == null) {\n        animation[animator.animation.property] = animator.animation.from;\n      }\n\n      return results;\n    }, {});\n  }\n\n  play() {\n    if (this.state !== Scrubber.states.FORWARD) {\n      this._lastTimestamp = this.clock.now();\n      this.state = Scrubber.states.FORWARD;\n      this.clock.register(this.tick);\n\n      this.notify({\n        type: \"PLAYED\",\n      });\n    }\n  }\n\n  tick() {\n    const timestamp = this.clock.now();\n    const deltaTime = timestamp - this._lastTimestamp;\n    let step = (deltaTime / this.duration) * this._timeScale;\n\n    if (step > 1) {\n      step = 1;\n    }\n\n    if (deltaTime === 0) {\n      return;\n    }\n\n    if (this.state === Scrubber.states.REVERSE) {\n      let progress = this._progress - step;\n      const repeatDirection = this.repeatDirection;\n      const ALTERNATE = Scrubber.repeatDirections.ALTERNATE;\n\n      if (progress <= 0) {\n        this._iterations++;\n\n        if (this._iterations >= this._repeat) {\n          this.seek(0);\n          this.stop();\n          return;\n        }\n\n        if (repeatDirection === ALTERNATE) {\n          progress = progress * -1;\n          this.seek(progress);\n          this.state = Scrubber.states.FORWARD;\n        } else {\n          progress = 1 + progress;\n          this.seek(progress);\n          this.state = Scrubber.states.REVERSE;\n        }\n      } else {\n        this.seek(progress);\n      }\n    } else if (this.state === Scrubber.states.FORWARD) {\n      let progress = this._progress + step;\n      const repeatDirection = this.repeatDirection;\n      const ALTERNATE = Scrubber.repeatDirections.ALTERNATE;\n\n      if (progress >= 1) {\n        this._iterations++;\n\n        if (this._iterations >= this._repeat) {\n          this.seek(1);\n          this.stop();\n          return;\n        }\n\n        if (repeatDirection === ALTERNATE) {\n          progress = 1 - (progress - 1);\n          this.seek(progress);\n          this.state = Scrubber.states.REVERSE;\n        } else {\n          progress = progress - 1;\n          this.seek(progress);\n          this.state = Scrubber.states.FORWARD;\n        }\n      } else {\n        this.seek(progress);\n      }\n    }\n\n    this._lastTimestamp = timestamp;\n  }\n\n  stop() {\n    if (this.state !== Scrubber.states.STOPPED) {\n      this.state = Scrubber.states.STOPPED;\n      this.clock.unregister(this.tick);\n\n      this.notify({\n        type: \"STOPPED\",\n      });\n    }\n  }\n\n  reverse() {\n    if (this.state !== Scrubber.states.REVERSE) {\n      this._lastTimestamp = this.clock.now();\n      this.state = Scrubber.states.REVERSE;\n      this.clock.register(this.tick);\n\n      this.notify({\n        type: \"REVERSED\",\n      });\n    }\n  }\n\n  seek(progress) {\n    const lastProgress = this._progress;\n    this._progress = progress;\n\n    const animations = this.getValuesAt(progress);\n\n    this.notify({\n      type: \"RENDER\",\n      progress: progress,\n      lastProgress: lastProgress,\n      animations,\n    });\n  }\n\n  getValuesAt(time) {\n    const results = this.currentValues;\n\n    // Animate the values that are less than the current time\n    this.animators\n      .filter((animator) => {\n        return animator.animation.startAt <= time;\n      })\n      .forEach((animator) => {\n        const animation = results[animator.animation.name];\n        animation[animator.animation.property] = animator.render(time);\n      });\n\n    this.animators\n      .filter((animator) => {\n        const min = Math.max(animator.animation.startAt, time);\n        const max = Math.min(animator.animation.endAt, time);\n\n        return min <= max;\n      })\n      .forEach((animator) => {\n        const animation = results[animator.animation.name];\n        animation[animator.animation.property] = animator.render(time);\n      });\n\n    return results;\n  }\n\n  getCurrentValues() {\n    return this.currentValues;\n  }\n\n  dispose() {\n    this.stop();\n    super.dispose();\n  }\n}\n"],"file":"Timeline.js"}