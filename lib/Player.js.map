{"version":3,"sources":["../src/Player.js"],"names":["defaultClock","DefaultClock","DEFAULT","ALTERNATE","FORWARD","REVERSE","STOPPED","repeatDirections","states","defaultRender","Player","animation","clock","duration","timeScale","repeatDirection","render","_timeScale","_time","_step","_duration","_lastTimestamp","_animationFrame","_iterations","_repeat","_repeatDirection","_animation","_clock","_state","_render","_slopeAnimationBuilder","SlopeAnimationBuilder","tick","bind","now","register","notify","type","timestamp","deltaTime","stepBackward","stepForward","time","lastTime","seek","stop","adjustedTime","update","unregister","easing","slopeAnimation","build","blendedAnimation","BlendedAnimation","observer","observeTime","dispose","transitionObserver","observe","value","Observable"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,YAAY,GAAG,IAAIC,qBAAJ,EAArB;AAEA,IAAMC,OAAO,GAAG,CAAhB;AACA,IAAMC,SAAS,GAAG,CAAlB;AAEA,IAAMC,OAAO,GAAG,CAAhB;AACA,IAAMC,OAAO,GAAG,CAAC,CAAjB;AACA,IAAMC,OAAO,GAAG,CAAhB;AAEA,IAAMC,gBAAgB,GAAG;AACvBL,EAAAA,OAAO,EAAPA,OADuB;AAEvBC,EAAAA,SAAS,EAATA;AAFuB,CAAzB;AAKA,IAAMK,MAAM,GAAG;AACbJ,EAAAA,OAAO,EAAPA,OADa;AAEbC,EAAAA,OAAO,EAAPA,OAFa;AAGbC,EAAAA,OAAO,EAAPA;AAHa,CAAf;;AAMA,SAASG,aAAT,GAAyB,CAAE;;IAENC,M;;;;;AACnB,kBACEC,SADF,QAGE;AAAA;;AAAA,QADEC,KACF,QADEA,KACF;AAAA,QADSC,QACT,QADSA,QACT;AAAA,QADmBC,SACnB,QADmBA,SACnB;AAAA,QAD8BC,eAC9B,QAD8BA,eAC9B;AAAA,QAD+CC,MAC/C,QAD+CA,MAC/C;;AAAA;;AACA;AACA,UAAKC,UAAL,GAAkB,OAAOH,SAAP,KAAqB,QAArB,GAAgCA,SAAhC,GAA4C,CAA9D;AACA,UAAKI,KAAL,GAAa,CAAb;AACA,UAAKC,KAAL,GAAa,CAAb;AACA,UAAKC,SAAL,GAAiBP,QAAjB;AACA,UAAKQ,cAAL,GAAsB,CAAtB;AACA,UAAKC,eAAL,GAAuB,IAAvB;AACA,UAAKC,WAAL,GAAmB,CAAnB;AACA,UAAKC,OAAL,GAAe,CAAf;AACA,UAAKC,gBAAL,GACE,OAAOV,eAAP,KAA2B,QAA3B,GAAsCA,eAAtC,GAAwDb,OAD1D;AAEA,UAAKwB,UAAL,GAAkBf,SAAlB;AACA,UAAKgB,MAAL,GAAcf,KAAK,IAAIZ,YAAvB;AACA,UAAK4B,MAAL,GAActB,OAAd;AACA,UAAKuB,OAAL,GAAe,OAAOb,MAAP,KAAkB,UAAlB,GAA+BA,MAA/B,GAAwCP,aAAvD;AACA,UAAKqB,sBAAL,GAA8B,IAAIC,8BAAJ,EAA9B;AAEA,UAAKC,IAAL,GAAY,MAAKA,IAAL,CAAUC,IAAV,+BAAZ;AAlBA;AAmBD;;;;2BA2EM;AACL,UAAI,KAAKL,MAAL,KAAgBxB,OAApB,EAA6B;AAC3B,aAAKiB,cAAL,GAAsB,KAAKM,MAAL,CAAYO,GAAZ,EAAtB;AACA,aAAKN,MAAL,GAAcxB,OAAd;;AACA,aAAKuB,MAAL,CAAYQ,QAAZ,CAAqB,KAAKH,IAA1B;;AAEA,aAAKI,MAAL,CAAY;AACVC,UAAAA,IAAI,EAAE,QADI;AAEV1B,UAAAA,SAAS,EAAE,KAAKe;AAFN,SAAZ;AAID;AACF;;;2BAEM;AACL,UAAMY,SAAS,GAAG,KAAKX,MAAL,CAAYO,GAAZ,EAAlB;;AACA,UAAMK,SAAS,GAAGD,SAAS,GAAG,KAAKjB,cAAnC;AACA,WAAKF,KAAL,GAAcoB,SAAS,GAAG,KAAKnB,SAAlB,GAA+B,KAAKH,UAAjD;;AAEA,UAAI,KAAKE,KAAL,GAAa,CAAjB,EAAoB;AAClB,aAAKA,KAAL,GAAa,CAAb;AACD;;AAED,UAAIoB,SAAS,KAAK,CAAlB,EAAqB;AACnB;AACD;;AAED,UAAI,KAAKX,MAAL,KAAgBvB,OAApB,EAA6B;AAC3B,aAAKmC,YAAL;AACD,OAFD,MAEO,IAAI,KAAKZ,MAAL,KAAgBxB,OAApB,EAA6B;AAClC,aAAKqC,WAAL;AACD;;AAED,WAAKpB,cAAL,GAAsBiB,SAAtB;AACD;;;kCAEa;AACZ,UAAII,IAAI,GAAG,KAAKxB,KAAL,GAAa,KAAKC,KAA7B;AACA,UAAIwB,QAAQ,GAAG,KAAKzB,KAApB;AAEA,UAAMH,eAAe,GAAG,KAAKU,gBAA7B;;AAEA,UAAIiB,IAAI,IAAI,CAAZ,EAAe;AACb,aAAKnB,WAAL;;AAEA,YAAI,KAAKA,WAAL,IAAoB,KAAKC,OAA7B,EAAsC;AACpC,eAAKoB,IAAL,CAAU,CAAV;AACA,eAAKC,IAAL;AACA;AACD;;AAED,YAAI9B,eAAe,KAAKZ,SAAxB,EAAmC;AACjC,cAAM2C,YAAY,GAAG,KAAKJ,IAAI,GAAG,CAAZ,CAArB;AAEA,eAAKN,MAAL,CAAY;AACVC,YAAAA,IAAI,EAAE,MADI;AAEVK,YAAAA,IAAI,EAAE,CAFI;AAGVC,YAAAA,QAAQ,EAARA,QAHU;AAIVhC,YAAAA,SAAS,EAAE,KAAKe;AAJN,WAAZ;AAOA,eAAKR,KAAL,GAAa,CAAb;AACA,eAAK0B,IAAL,CAAUE,YAAV;AACA,eAAKlB,MAAL,GAAcvB,OAAd;AACD,SAbD,MAaO;AACL,cAAMyC,aAAY,GAAGJ,IAAI,GAAG,CAA5B;;AAEA,eAAKN,MAAL,CAAY;AACVC,YAAAA,IAAI,EAAE,MADI;AAEVK,YAAAA,IAAI,EAAE,CAFI;AAGVC,YAAAA,QAAQ,EAARA,QAHU;AAIVhC,YAAAA,SAAS,EAAE,KAAKe;AAJN,WAAZ;AAOA,eAAKR,KAAL,GAAa,CAAb;AACA,eAAK0B,IAAL,CAAUE,aAAV;AACA,eAAKlB,MAAL,GAAcxB,OAAd;AACD;AACF,OApCD,MAoCO;AACL,aAAKwC,IAAL,CAAUF,IAAV;AACD;AACF;;;mCAEc;AACb,UAAIA,IAAI,GAAG,KAAKxB,KAAL,GAAa,KAAKC,KAA7B;AACA,UAAIwB,QAAQ,GAAG,KAAKzB,KAApB;AAEA,UAAMH,eAAe,GAAG,KAAKU,gBAA7B;;AAEA,UAAIiB,IAAI,IAAI,CAAZ,EAAe;AACb,aAAKnB,WAAL;;AAEA,YAAI,KAAKA,WAAL,IAAoB,KAAKC,OAA7B,EAAsC;AACpC,eAAKoB,IAAL,CAAU,CAAV;AACA,eAAKC,IAAL;AACA;AACD;;AAED,YAAI9B,eAAe,KAAKZ,SAAxB,EAAmC;AACjC,cAAM2C,YAAY,GAAGJ,IAAI,GAAG,CAAC,CAA7B;AAEA,eAAKN,MAAL,CAAY;AACVC,YAAAA,IAAI,EAAE,MADI;AAEVK,YAAAA,IAAI,EAAE,CAFI;AAGVC,YAAAA,QAAQ,EAARA,QAHU;AAIVhC,YAAAA,SAAS,EAAE,KAAKe;AAJN,WAAZ;AAOA,eAAKR,KAAL,GAAa,CAAb;AACA,eAAK0B,IAAL,CAAUE,YAAV;AACA,eAAKlB,MAAL,GAAcxB,OAAd;AACD,SAbD,MAaO;AACL,cAAM0C,cAAY,GAAG,IAAIJ,IAAzB;;AAEA,eAAKN,MAAL,CAAY;AACVC,YAAAA,IAAI,EAAE,MADI;AAEVK,YAAAA,IAAI,EAAE,CAFI;AAGVC,YAAAA,QAAQ,EAARA,QAHU;AAIVhC,YAAAA,SAAS,EAAE,KAAKe;AAJN,WAAZ;AAOA,eAAKR,KAAL,GAAa,CAAb;AACA,eAAK0B,IAAL,CAAUE,cAAV;AACA,eAAKlB,MAAL,GAAcvB,OAAd;AACD;AACF,OApCD,MAoCO;AACL,aAAKuC,IAAL,CAAUF,IAAV;AACD;AACF;;;yBAEIA,I,EAAM;AACT,UAAMC,QAAQ,GAAG,KAAKzB,KAAtB;AACA,WAAKA,KAAL,GAAawB,IAAb;;AAEA,WAAKhB,UAAL,CAAgBqB,MAAhB,CAAuB,KAAK7B,KAA5B;;AACA,WAAKW,OAAL,CAAa,KAAKH,UAAlB;;AAEA,WAAKU,MAAL,CAAY;AACVC,QAAAA,IAAI,EAAE,MADI;AAEVK,QAAAA,IAAI,EAAJA,IAFU;AAGVC,QAAAA,QAAQ,EAARA,QAHU;AAIVhC,QAAAA,SAAS,EAAE,KAAKe;AAJN,OAAZ;AAMD;;;2BAEM;AACL,UAAI,KAAKE,MAAL,KAAgBtB,OAApB,EAA6B;AAC3B,aAAKsB,MAAL,GAActB,OAAd;;AACA,aAAKqB,MAAL,CAAYqB,UAAZ,CAAuB,KAAKhB,IAA5B;;AAEA,aAAKI,MAAL,CAAY;AACVC,UAAAA,IAAI,EAAE,SADI;AAEV1B,UAAAA,SAAS,EAAE,KAAKe;AAFN,SAAZ;AAID;AACF;;;8BAES;AACR,UAAI,KAAKE,MAAL,KAAgBvB,OAApB,EAA6B;AAC3B,aAAKgB,cAAL,GAAsB,KAAKM,MAAL,CAAYO,GAAZ,EAAtB;AACA,aAAKN,MAAL,GAAcvB,OAAd;;AACA,aAAKsB,MAAL,CAAYQ,QAAZ,CAAqB,KAAKH,IAA1B;;AAEA,aAAKI,MAAL,CAAY;AACVC,UAAAA,IAAI,EAAE,UADI;AAEV1B,UAAAA,SAAS,EAAE,KAAKe;AAFN,SAAZ;AAID;AACF;;;yCAEoBf,S,EAAWE,Q,EAAUoC,M,EAAQ;AAAA;;AAChD,UAAMC,cAAc,GAAG,KAAKpB,sBAAL,CAA4BqB,KAA5B,CACrB,KAAKzB,UADgB,EAErB,KAAKR,KAFgB,EAGrB,KAAKE,SAHgB,EAIrBP,QAJqB,EAKrB,KAAKe,MALgB,CAAvB;;AAQA,UAAMwB,gBAAgB,GAAG,IAAIC,yBAAJ,CACvBH,cADuB,EAEvBvC,SAFuB,EAGvBsC,MAHuB,CAAzB;AAMA,WAAKvB,UAAL,GAAkB0B,gBAAlB;AACA,WAAKlC,KAAL,GAAa,CAAb;AACA,WAAKE,SAAL,GAAiBP,QAAjB;AAEA,WAAKuB,MAAL,CAAY;AACVC,QAAAA,IAAI,EAAE,YADI;AAEV1B,QAAAA,SAAS,EAAE,KAAKe;AAFN,OAAZ;AAKA,UAAM4B,QAAQ,GAAG,KAAKC,WAAL,CAAiB,CAAjB,EAAoB,YAAM;AACzC,QAAA,MAAI,CAAC7B,UAAL,GAAkBf,SAAlB;AACA2C,QAAAA,QAAQ,CAACE,OAAT;AACAC,QAAAA,kBAAkB,CAACD,OAAnB;AACD,OAJgB,CAAjB;AAMA,UAAMC,kBAAkB,GAAG,KAAKC,OAAL,CAAa,YAAb,EAA2B,YAAM;AAC1DJ,QAAAA,QAAQ,CAACE,OAAT;AACAC,QAAAA,kBAAkB,CAACD,OAAnB;AACD,OAH0B,CAA3B;AAKA,aAAO,IAAP;AACD;;;8BAES;AACR,WAAKX,IAAL;;AACA;AACD;;;wBA3RU;AACT,aAAO,KAAK3B,KAAZ;AACD;;;wBAEe;AACd,aAAO,KAAKD,UAAZ;AACD,K;sBAEa0C,K,EAAO;AACnB,UAAIA,KAAK,GAAG,CAAZ,EAAe;AACb,aAAK1C,UAAL,GAAkB0C,KAAlB;AACD;AACF;;;wBAEc;AACb,aAAO,KAAKvC,SAAZ;AACD,K;sBAEYuC,K,EAAO;AAClB,UAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;AAC7BA,QAAAA,KAAK,GAAG,CAAR;AACD,OAHiB,CAKlB;;;AACA,UAAIA,KAAK,IAAI,CAAb,EAAgB;AACdA,QAAAA,KAAK,GAAG,OAAR;AACD;;AAED,WAAKvC,SAAL,GAAiBuC,KAAjB;AACD;;;wBAEY;AACX,aAAO,KAAKnC,OAAZ;AACD,K;sBAEUmC,K,EAAO;AAChB,UAAI,OAAOA,KAAP,KAAiB,QAAjB,IAA6BA,KAAK,GAAG,CAAzC,EAA4C;AAC1C;AACD;;AAED,WAAKnC,OAAL,GAAemC,KAAf;AACD;;;wBAEqB;AACpB,aAAO,KAAKlC,gBAAZ;AACD,K;sBAEmBkC,K,EAAO;AACzB,UAAKA,KAAK,KAAK,CAAX,GAAiBA,KAAK,KAAK,CAA/B,EAAmC;AACjC;AACD;;AAED,WAAKlC,gBAAL,GAAwBkC,KAAxB;AACD;;;wBAEW;AACV,aAAO,KAAK/B,MAAZ;AACD;;;wBAEe;AACd,aAAO,KAAKF,UAAZ;AACD,K;sBAEaf,S,EAAW;AACvB,UAAI,OAAOA,SAAS,CAACK,MAAjB,KAA4B,UAAhC,EAA4C;AAC1C,aAAKU,UAAL,GAAkBf,SAAlB;AACD;AACF;;;wBAEgB;AACf,aAAO,KAAKY,WAAZ;AACD;;;wBAsN6B;AAC5B,aAAOhB,gBAAP;AACD;;;wBAEmB;AAClB,aAAOC,MAAP;AACD;;;;EA5TiCoD,oB","sourcesContent":["import Observable from \"./Observable.js\";\nimport DefaultClock from \"./DefaultClock.js\";\nimport SlopeAnimationBuilder from \"./SlopeAnimationBuilder.js\";\nimport BlendedAnimation from \"./BlendedAnimation.js\";\n\nconst defaultClock = new DefaultClock();\n\nconst DEFAULT = 0;\nconst ALTERNATE = 1;\n\nconst FORWARD = 1;\nconst REVERSE = -1;\nconst STOPPED = 0;\n\nconst repeatDirections = {\n  DEFAULT,\n  ALTERNATE,\n};\n\nconst states = {\n  FORWARD,\n  REVERSE,\n  STOPPED,\n};\n\nfunction defaultRender() {}\n\nexport default class Player extends Observable {\n  constructor(\n    animation,\n    { clock, duration, timeScale, repeatDirection, render }\n  ) {\n    super();\n    this._timeScale = typeof timeScale === \"number\" ? timeScale : 1;\n    this._time = 0;\n    this._step = 0;\n    this._duration = duration;\n    this._lastTimestamp = 0;\n    this._animationFrame = null;\n    this._iterations = 0;\n    this._repeat = 1;\n    this._repeatDirection =\n      typeof repeatDirection === \"number\" ? repeatDirection : DEFAULT;\n    this._animation = animation;\n    this._clock = clock || defaultClock;\n    this._state = STOPPED;\n    this._render = typeof render === \"function\" ? render : defaultRender;\n    this._slopeAnimationBuilder = new SlopeAnimationBuilder();\n\n    this.tick = this.tick.bind(this);\n  }\n\n  get time() {\n    return this._time;\n  }\n\n  get timeScale() {\n    return this._timeScale;\n  }\n\n  set timeScale(value) {\n    if (value > 0) {\n      this._timeScale = value;\n    }\n  }\n\n  get duration() {\n    return this._duration;\n  }\n\n  set duration(value) {\n    if (typeof value !== \"number\") {\n      value = 0;\n    }\n\n    // Virtually Nothing. All Math blows up if the duration is \"0\".\n    if (value <= 0) {\n      value = 0.00001;\n    }\n\n    this._duration = value;\n  }\n\n  get repeat() {\n    return this._repeat;\n  }\n\n  set repeat(value) {\n    if (typeof value !== \"number\" && value > 0) {\n      return;\n    }\n\n    this._repeat = value;\n  }\n\n  get repeatDirection() {\n    return this._repeatDirection;\n  }\n\n  set repeatDirection(value) {\n    if ((value !== 0) & (value !== 1)) {\n      return;\n    }\n\n    this._repeatDirection = value;\n  }\n\n  get state() {\n    return this._state;\n  }\n\n  get animation() {\n    return this._animation;\n  }\n\n  set animation(animation) {\n    if (typeof animation.render === \"function\") {\n      this._animation = animation;\n    }\n  }\n\n  get iterations() {\n    return this._iterations;\n  }\n\n  play() {\n    if (this._state !== FORWARD) {\n      this._lastTimestamp = this._clock.now();\n      this._state = FORWARD;\n      this._clock.register(this.tick);\n\n      this.notify({\n        type: \"PLAYED\",\n        animation: this._animation,\n      });\n    }\n  }\n\n  tick() {\n    const timestamp = this._clock.now();\n    const deltaTime = timestamp - this._lastTimestamp;\n    this._step = (deltaTime / this._duration) * this._timeScale;\n\n    if (this._step > 1) {\n      this._step = 1;\n    }\n\n    if (deltaTime === 0) {\n      return;\n    }\n\n    if (this._state === REVERSE) {\n      this.stepBackward();\n    } else if (this._state === FORWARD) {\n      this.stepForward();\n    }\n\n    this._lastTimestamp = timestamp;\n  }\n\n  stepForward() {\n    let time = this._time + this._step;\n    let lastTime = this._time;\n\n    const repeatDirection = this._repeatDirection;\n\n    if (time >= 1) {\n      this._iterations++;\n\n      if (this._iterations >= this._repeat) {\n        this.seek(1);\n        this.stop();\n        return;\n      }\n\n      if (repeatDirection === ALTERNATE) {\n        const adjustedTime = 1 - (time - 1);\n\n        this.notify({\n          type: \"TICK\",\n          time: 1,\n          lastTime,\n          animation: this._animation,\n        });\n\n        this._time = 1;\n        this.seek(adjustedTime);\n        this._state = REVERSE;\n      } else {\n        const adjustedTime = time - 1;\n\n        this.notify({\n          type: \"TICK\",\n          time: 1,\n          lastTime,\n          animation: this._animation,\n        });\n\n        this._time = 0;\n        this.seek(adjustedTime);\n        this._state = FORWARD;\n      }\n    } else {\n      this.seek(time);\n    }\n  }\n\n  stepBackward() {\n    let time = this._time - this._step;\n    let lastTime = this._time;\n\n    const repeatDirection = this._repeatDirection;\n\n    if (time <= 0) {\n      this._iterations++;\n\n      if (this._iterations >= this._repeat) {\n        this.seek(0);\n        this.stop();\n        return;\n      }\n\n      if (repeatDirection === ALTERNATE) {\n        const adjustedTime = time * -1;\n\n        this.notify({\n          type: \"TICK\",\n          time: 0,\n          lastTime,\n          animation: this._animation,\n        });\n\n        this._time = 0;\n        this.seek(adjustedTime);\n        this._state = FORWARD;\n      } else {\n        const adjustedTime = 1 + time;\n\n        this.notify({\n          type: \"TICK\",\n          time: 1,\n          lastTime,\n          animation: this._animation,\n        });\n\n        this._time = 1;\n        this.seek(adjustedTime);\n        this._state = REVERSE;\n      }\n    } else {\n      this.seek(time);\n    }\n  }\n\n  seek(time) {\n    const lastTime = this._time;\n    this._time = time;\n\n    this._animation.update(this._time);\n    this._render(this._animation);\n\n    this.notify({\n      type: \"TICK\",\n      time,\n      lastTime,\n      animation: this._animation,\n    });\n  }\n\n  stop() {\n    if (this._state !== STOPPED) {\n      this._state = STOPPED;\n      this._clock.unregister(this.tick);\n\n      this.notify({\n        type: \"STOPPED\",\n        animation: this._animation,\n      });\n    }\n  }\n\n  reverse() {\n    if (this._state !== REVERSE) {\n      this._lastTimestamp = this._clock.now();\n      this._state = REVERSE;\n      this._clock.register(this.tick);\n\n      this.notify({\n        type: \"REVERSED\",\n        animation: this._animation,\n      });\n    }\n  }\n\n  transitionToTimeline(animation, duration, easing) {\n    const slopeAnimation = this._slopeAnimationBuilder.build(\n      this._animation,\n      this._time,\n      this._duration,\n      duration,\n      this._state\n    );\n\n    const blendedAnimation = new BlendedAnimation(\n      slopeAnimation,\n      animation,\n      easing\n    );\n\n    this._animation = blendedAnimation;\n    this._time = 0;\n    this._duration = duration;\n\n    this.notify({\n      type: \"TRANSITION\",\n      animation: this._animation,\n    });\n\n    const observer = this.observeTime(1, () => {\n      this._animation = animation;\n      observer.dispose();\n      transitionObserver.dispose();\n    });\n\n    const transitionObserver = this.observe(\"TRANSITION\", () => {\n      observer.dispose();\n      transitionObserver.dispose();\n    });\n\n    return this;\n  }\n\n  dispose() {\n    this.stop();\n    super.dispose();\n  }\n\n  static get repeatDirections() {\n    return repeatDirections;\n  }\n\n  static get states() {\n    return states;\n  }\n}\n"],"file":"Player.js"}