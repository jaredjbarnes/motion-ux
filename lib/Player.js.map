{"version":3,"sources":["../src/Player.js"],"names":["defaultClock","DefaultClock","DEFAULT","ALTERNATE","FORWARD","REVERSE","STOPPED","repeatDirections","states","Player","timeline","clock","duration","timeScale","repeatDirection","_timeScale","_time","_step","_duration","_lastTimestamp","_animationFrame","_iterations","_repeat","_repeatDirection","_timeline","_clock","_state","tick","bind","now","register","notify","type","timestamp","deltaTime","stepBackward","stepForward","time","seek","stop","lastTime","render","unregister","value","Observable"],"mappings":";;;;;;;AAAA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,YAAY,GAAG,IAAIC,qBAAJ,EAArB;AAEA,IAAMC,OAAO,GAAG,CAAhB;AACA,IAAMC,SAAS,GAAG,CAAlB;AAEA,IAAMC,OAAO,GAAG,CAAhB;AACA,IAAMC,OAAO,GAAG,CAAC,CAAjB;AACA,IAAMC,OAAO,GAAG,CAAhB;AAEA,IAAMC,gBAAgB,GAAG;AACvBL,EAAAA,OAAO,EAAPA,OADuB;AAEvBC,EAAAA,SAAS,EAATA;AAFuB,CAAzB;AAKA,IAAMK,MAAM,GAAG;AACbJ,EAAAA,OAAO,EAAPA,OADa;AAEbC,EAAAA,OAAO,EAAPA,OAFa;AAGbC,EAAAA,OAAO,EAAPA;AAHa,CAAf;;IAMqBG,M;;;;;AACnB,kBAAYC,QAAZ,QAAuE;AAAA;;AAAA,QAA/CC,KAA+C,QAA/CA,KAA+C;AAAA,QAAxCC,QAAwC,QAAxCA,QAAwC;AAAA,QAA9BC,SAA8B,QAA9BA,SAA8B;AAAA,QAAnBC,eAAmB,QAAnBA,eAAmB;;AAAA;;AACrE;AACA,UAAKC,UAAL,GAAkB,OAAOF,SAAP,KAAqB,QAArB,GAAgCA,SAAhC,GAA4C,CAA9D;AACA,UAAKG,KAAL,GAAa,CAAb;AACA,UAAKC,KAAL,GAAa,CAAb;AACA,UAAKC,SAAL,GAAiBN,QAAjB;AACA,UAAKO,cAAL,GAAsB,CAAtB;AACA,UAAKC,eAAL,GAAuB,IAAvB;AACA,UAAKC,WAAL,GAAmB,CAAnB;AACA,UAAKC,OAAL,GAAe,CAAf;AACA,UAAKC,gBAAL,GACE,OAAOT,eAAP,KAA2B,QAA3B,GAAsCA,eAAtC,GAAwDZ,OAD1D;AAEA,UAAKsB,SAAL,GAAiBd,QAAjB;AACA,UAAKe,MAAL,GAAcd,KAAK,IAAIX,YAAvB;AACA,UAAK0B,MAAL,GAAcpB,OAAd;AAEA,UAAKqB,IAAL,GAAY,MAAKA,IAAL,CAAUC,IAAV,+BAAZ;AAhBqE;AAiBtE;;;;2BAuEM;AACL,UAAI,KAAKF,MAAL,KAAgBtB,OAApB,EAA6B;AAC3B,aAAKe,cAAL,GAAsB,KAAKM,MAAL,CAAYI,GAAZ,EAAtB;AACA,aAAKH,MAAL,GAActB,OAAd;;AACA,aAAKqB,MAAL,CAAYK,QAAZ,CAAqB,KAAKH,IAA1B;;AAEA,aAAKI,MAAL,CAAY;AACVC,UAAAA,IAAI,EAAE,QADI;AAEVtB,UAAAA,QAAQ,EAAE,KAAKc;AAFL,SAAZ;AAID;AACF;;;2BAEM;AACL,UAAMS,SAAS,GAAG,KAAKR,MAAL,CAAYI,GAAZ,EAAlB;;AACA,UAAMK,SAAS,GAAGD,SAAS,GAAG,KAAKd,cAAnC;AACA,WAAKF,KAAL,GAAciB,SAAS,GAAG,KAAKhB,SAAlB,GAA+B,KAAKH,UAAjD;;AAEA,UAAI,KAAKE,KAAL,GAAa,CAAjB,EAAoB;AAClB,aAAKA,KAAL,GAAa,CAAb;AACD;;AAED,UAAIiB,SAAS,KAAK,CAAlB,EAAqB;AACnB;AACD;;AAED,UAAI,KAAKR,MAAL,KAAgBrB,OAApB,EAA6B;AAC3B,aAAK8B,YAAL;AACD,OAFD,MAEO,IAAI,KAAKT,MAAL,KAAgBtB,OAApB,EAA6B;AAClC,aAAKgC,WAAL;AACD;;AAED,WAAKjB,cAAL,GAAsBc,SAAtB;AACD;;;kCAEa;AACZ,UAAII,IAAI,GAAG,KAAKrB,KAAL,GAAa,KAAKC,KAA7B;AACA,UAAMH,eAAe,GAAG,KAAKS,gBAA7B;;AAEA,UAAIc,IAAI,IAAI,CAAZ,EAAe;AACb,aAAKhB,WAAL;;AAEA,YAAI,KAAKA,WAAL,IAAoB,KAAKC,OAA7B,EAAsC;AACpC,eAAKgB,IAAL,CAAU,CAAV;AACA,eAAKC,IAAL;AACA;AACD;;AAED,YAAIzB,eAAe,KAAKX,SAAxB,EAAmC;AACjCkC,UAAAA,IAAI,GAAG,KAAKA,IAAI,GAAG,CAAZ,CAAP;AACA,eAAKC,IAAL,CAAUD,IAAV;AACA,eAAKX,MAAL,GAAcrB,OAAd;AACD,SAJD,MAIO;AACLgC,UAAAA,IAAI,GAAGA,IAAI,GAAG,CAAd;AACA,eAAKC,IAAL,CAAUD,IAAV;AACA,eAAKX,MAAL,GAActB,OAAd;AACD;AAEF,OAnBD,MAmBO;AACL,aAAKkC,IAAL,CAAUD,IAAV;AACD;AACF;;;kCAEa;AACZ,UAAIA,IAAI,GAAG,KAAKrB,KAAL,GAAa,KAAKC,KAA7B;AACA,UAAMH,eAAe,GAAG,KAAKS,gBAA7B;;AAEA,UAAIc,IAAI,IAAI,CAAZ,EAAe;AACb,aAAKhB,WAAL;;AAEA,YAAI,KAAKA,WAAL,IAAoB,KAAKC,OAA7B,EAAsC;AACpC,eAAKgB,IAAL,CAAU,CAAV;AACA,eAAKC,IAAL;AACA;AACD;;AAED,YAAIzB,eAAe,KAAKX,SAAxB,EAAmC;AACjCkC,UAAAA,IAAI,GAAGA,IAAI,GAAG,CAAC,CAAf;AACA,eAAKC,IAAL,CAAUD,IAAV;AACA,eAAKX,MAAL,GAActB,OAAd;AACD,SAJD,MAIO;AACLiC,UAAAA,IAAI,GAAG,IAAIA,IAAX;AACA,eAAKC,IAAL,CAAUD,IAAV;AACA,eAAKX,MAAL,GAAcrB,OAAd;AACD;AACF,OAlBD,MAkBO;AACL,aAAKiC,IAAL,CAAUD,IAAV;AACD;AACF;;;yBAEIA,I,EAAM;AACT,UAAMG,QAAQ,GAAG,KAAKxB,KAAtB;AACA,WAAKA,KAAL,GAAaqB,IAAb;;AAEA,WAAKb,SAAL,CAAeiB,MAAf,CAAsB,KAAKzB,KAA3B;;AAEA,WAAKe,MAAL,CAAY;AACVC,QAAAA,IAAI,EAAE,QADI;AAEVK,QAAAA,IAAI,EAAJA,IAFU;AAGVG,QAAAA,QAAQ,EAARA,QAHU;AAIV9B,QAAAA,QAAQ,EAAE,KAAKc;AAJL,OAAZ;AAMD;;;2BAEM;AACL,UAAI,KAAKE,MAAL,KAAgBpB,OAApB,EAA6B;AAC3B,aAAKoB,MAAL,GAAcpB,OAAd;;AACA,aAAKmB,MAAL,CAAYiB,UAAZ,CAAuB,KAAKf,IAA5B;;AAEA,aAAKI,MAAL,CAAY;AACVC,UAAAA,IAAI,EAAE,SADI;AAEVtB,UAAAA,QAAQ,EAAE,KAAKc;AAFL,SAAZ;AAID;AACF;;;8BAES;AACR,UAAI,KAAKE,MAAL,KAAgBrB,OAApB,EAA6B;AAC3B,aAAKc,cAAL,GAAsB,KAAKM,MAAL,CAAYI,GAAZ,EAAtB;AACA,aAAKH,MAAL,GAAcrB,OAAd;;AACA,aAAKoB,MAAL,CAAYK,QAAZ,CAAqB,KAAKH,IAA1B;;AAEA,aAAKI,MAAL,CAAY;AACVC,UAAAA,IAAI,EAAE,UADI;AAEVtB,UAAAA,QAAQ,EAAE,KAAKc;AAFL,SAAZ;AAID;AACF;;;8BAES;AACR,WAAKe,IAAL;;AACA;AACD;;;wBAzMU;AACT,aAAO,KAAKvB,KAAZ;AACD;;;wBAEe;AACd,aAAO,KAAKD,UAAZ;AACD,K;sBAEa4B,K,EAAO;AACnB,UAAIA,KAAK,GAAG,CAAZ,EAAe;AACb,aAAK5B,UAAL,GAAkB4B,KAAlB;AACD;AACF;;;wBAEc;AACb,aAAO,KAAKzB,SAAZ;AACD,K;sBAEYyB,K,EAAO;AAClB,UAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;AAC7BA,QAAAA,KAAK,GAAG,CAAR;AACD,OAHiB,CAKlB;;;AACA,UAAIA,KAAK,IAAI,CAAb,EAAgB;AACdA,QAAAA,KAAK,GAAG,OAAR;AACD;;AAED,WAAKzB,SAAL,GAAiByB,KAAjB;AACD;;;wBAEY;AACX,aAAO,KAAKrB,OAAZ;AACD,K;sBAEUqB,K,EAAO;AAChB,UAAI,OAAOA,KAAP,KAAiB,QAAjB,IAA6BA,KAAK,GAAG,CAAzC,EAA4C;AAC1C;AACD;;AAED,WAAKrB,OAAL,GAAeqB,KAAf;AACD;;;wBAEqB;AACpB,aAAO,KAAKpB,gBAAZ;AACD,K;sBAEmBoB,K,EAAO;AACzB,UAAKA,KAAK,KAAK,CAAX,GAAiBA,KAAK,KAAK,CAA/B,EAAmC;AACjC;AACD;;AAED,WAAKpB,gBAAL,GAAwBoB,KAAxB;AACD;;;wBAEW;AACV,aAAO,KAAKjB,MAAZ;AACD;;;wBAEc;AACb,aAAO,KAAKF,SAAZ;AACD,K;sBAEYd,Q,EAAU;AACrB,UAAI,OAAOA,QAAQ,CAAC+B,MAAhB,KAA2B,UAA/B,EAA2C;AACzC,aAAKjB,SAAL,GAAiBd,QAAjB;AACD;AACF;;;wBAwI6B;AAC5B,aAAOH,gBAAP;AACD;;;wBAEmB;AAClB,aAAOC,MAAP;AACD;;;;EArOiCoC,oB","sourcesContent":["import Observable from \"./Observable.js\";\nimport DefaultClock from \"./DefaultClock.js\";\n\nconst defaultClock = new DefaultClock();\n\nconst DEFAULT = 0;\nconst ALTERNATE = 1;\n\nconst FORWARD = 1;\nconst REVERSE = -1;\nconst STOPPED = 0;\n\nconst repeatDirections = {\n  DEFAULT,\n  ALTERNATE,\n};\n\nconst states = {\n  FORWARD,\n  REVERSE,\n  STOPPED,\n};\n\nexport default class Player extends Observable {\n  constructor(timeline, { clock, duration, timeScale, repeatDirection }) {\n    super();\n    this._timeScale = typeof timeScale === \"number\" ? timeScale : 1;\n    this._time = 0;\n    this._step = 0;\n    this._duration = duration;\n    this._lastTimestamp = 0;\n    this._animationFrame = null;\n    this._iterations = 0;\n    this._repeat = 1;\n    this._repeatDirection =\n      typeof repeatDirection === \"number\" ? repeatDirection : DEFAULT;\n    this._timeline = timeline;\n    this._clock = clock || defaultClock;\n    this._state = STOPPED;\n\n    this.tick = this.tick.bind(this);\n  }\n\n  get time() {\n    return this._time;\n  }\n\n  get timeScale() {\n    return this._timeScale;\n  }\n\n  set timeScale(value) {\n    if (value > 0) {\n      this._timeScale = value;\n    }\n  }\n\n  get duration() {\n    return this._duration;\n  }\n\n  set duration(value) {\n    if (typeof value !== \"number\") {\n      value = 0;\n    }\n\n    // Virtually Nothing. All Math blows up if the duration is \"0\".\n    if (value <= 0) {\n      value = 0.00001;\n    }\n\n    this._duration = value;\n  }\n\n  get repeat() {\n    return this._repeat;\n  }\n\n  set repeat(value) {\n    if (typeof value !== \"number\" && value > 0) {\n      return;\n    }\n\n    this._repeat = value;\n  }\n\n  get repeatDirection() {\n    return this._repeatDirection;\n  }\n\n  set repeatDirection(value) {\n    if ((value !== 0) & (value !== 1)) {\n      return;\n    }\n\n    this._repeatDirection = value;\n  }\n\n  get state() {\n    return this._state;\n  }\n\n  get timeline() {\n    return this._timeline;\n  }\n\n  set timeline(timeline) {\n    if (typeof timeline.render === \"function\") {\n      this._timeline = timeline;\n    }\n  }\n\n  play() {\n    if (this._state !== FORWARD) {\n      this._lastTimestamp = this._clock.now();\n      this._state = FORWARD;\n      this._clock.register(this.tick);\n\n      this.notify({\n        type: \"PLAYED\",\n        timeline: this._timeline,\n      });\n    }\n  }\n\n  tick() {\n    const timestamp = this._clock.now();\n    const deltaTime = timestamp - this._lastTimestamp;\n    this._step = (deltaTime / this._duration) * this._timeScale;\n\n    if (this._step > 1) {\n      this._step = 1;\n    }\n\n    if (deltaTime === 0) {\n      return;\n    }\n\n    if (this._state === REVERSE) {\n      this.stepBackward();\n    } else if (this._state === FORWARD) {\n      this.stepForward();\n    }\n\n    this._lastTimestamp = timestamp;\n  }\n\n  stepForward() {\n    let time = this._time + this._step;\n    const repeatDirection = this._repeatDirection;\n\n    if (time >= 1) {\n      this._iterations++;\n\n      if (this._iterations >= this._repeat) {\n        this.seek(1);\n        this.stop();\n        return;\n      }\n\n      if (repeatDirection === ALTERNATE) {\n        time = 1 - (time - 1);\n        this.seek(time);\n        this._state = REVERSE;\n      } else {\n        time = time - 1;\n        this.seek(time);\n        this._state = FORWARD;\n      }\n\n    } else {\n      this.seek(time);\n    }\n  }\n\n  setBackward() {\n    let time = this._time - this._step;\n    const repeatDirection = this._repeatDirection;\n\n    if (time <= 0) {\n      this._iterations++;\n\n      if (this._iterations >= this._repeat) {\n        this.seek(0);\n        this.stop();\n        return;\n      }\n\n      if (repeatDirection === ALTERNATE) {\n        time = time * -1;\n        this.seek(time);\n        this._state = FORWARD;\n      } else {\n        time = 1 + time;\n        this.seek(time);\n        this._state = REVERSE;\n      }\n    } else {\n      this.seek(time);\n    }\n  }\n\n  seek(time) {\n    const lastTime = this._time;\n    this._time = time;\n\n    this._timeline.render(this._time);\n\n    this.notify({\n      type: \"RENDER\",\n      time,\n      lastTime,\n      timeline: this._timeline,\n    });\n  }\n\n  stop() {\n    if (this._state !== STOPPED) {\n      this._state = STOPPED;\n      this._clock.unregister(this.tick);\n\n      this.notify({\n        type: \"STOPPED\",\n        timeline: this._timeline,\n      });\n    }\n  }\n\n  reverse() {\n    if (this._state !== REVERSE) {\n      this._lastTimestamp = this._clock.now();\n      this._state = REVERSE;\n      this._clock.register(this.tick);\n\n      this.notify({\n        type: \"REVERSED\",\n        timeline: this._timeline,\n      });\n    }\n  }\n\n  dispose() {\n    this.stop();\n    super.dispose();\n  }\n\n  static get repeatDirections() {\n    return repeatDirections;\n  }\n\n  static get states() {\n    return states;\n  }\n}\n"],"file":"Player.js"}